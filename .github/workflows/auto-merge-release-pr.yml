name: auto-merge-release-pr

on:
  pull_request_target:
    types: [opened, reopened, synchronize, ready_for_review]
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  enable-auto-merge:
    if: >
      github.event.pull_request.head.repo.full_name == github.repository &&
      startsWith(github.event.pull_request.head.ref, 'release-please--') &&
      github.event.pull_request.state == 'open' &&
      github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    steps:
      - name: Enable auto-merge for release PR
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              core.setFailed("No pull request payload found.");
              return;
            }

            if (pr.auto_merge) {
              core.info(`Auto-merge already enabled for PR #${pr.number}.`);
              return;
            }

            try {
              await github.graphql(
                `
                mutation EnableAutoMerge($pullRequestId: ID!) {
                  enablePullRequestAutoMerge(
                    input: { pullRequestId: $pullRequestId, mergeMethod: MERGE }
                  ) {
                    pullRequest {
                      number
                    }
                  }
                }
                `,
                { pullRequestId: pr.node_id },
              );

              core.info(`Enabled auto-merge for release PR #${pr.number}.`);
            } catch (error) {
              core.setFailed(`Failed to enable auto-merge for PR #${pr.number}: ${error}`);
            }
